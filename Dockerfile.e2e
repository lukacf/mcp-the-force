# E2E Testing Dockerfile
FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git \
        curl \
        ca-certificates \
        nodejs \
        npm && \
    rm -rf /var/lib/apt/lists/*

# Install uv first
RUN pip install uv

# Set working directory
WORKDIR /app

# Copy project files
COPY pyproject.toml README.md ./
COPY mcp_second_brain ./mcp_second_brain
COPY *.md *.py ./

# Copy test files (needed for mock_claude_code.py)
COPY tests/e2e ./tests/e2e

# Create a Python-based mock Claude Code CLI for E2E testing
# This will actually invoke the MCP server for testing
RUN cp tests/e2e/mock_claude_code.py /usr/local/bin/mock_claude_code.py && \
    echo '#!/usr/bin/env python3\n\
import sys\n\
import os\n\
sys.path.insert(0, "/usr/local/bin")\n\
import mock_claude_code\n\
mock_claude_code.main()\n' > /usr/local/bin/claude && \
    chmod +x /usr/local/bin/claude

# Verify mock Claude Code installation
RUN claude --version

# Install production dependencies
RUN uv pip install --system .

# Install test dependencies
RUN pip install pytest anyio pytest-timeout

# Create non-root user
RUN useradd -m -u 1000 tester && \
    chown -R tester:tester /app

# Switch to non-root user
USER tester
ENV HOME=/home/tester
ENV XDG_CONFIG_HOME=$HOME/.config

# Create Claude config directory
RUN mkdir -p $HOME/.config/claude

# Add MCP server using claude mcp add-json
RUN claude mcp add-json second-brain '{ \
  "command": "uv", \
  "args": ["run", "--", "mcp-second-brain"], \
  "env": { \
    "OPENAI_API_KEY": "${OPENAI_API_KEY}", \
    "VERTEX_PROJECT": "${VERTEX_PROJECT}", \
    "VERTEX_LOCATION": "${VERTEX_LOCATION}", \
    "MCP_ADAPTER_MOCK": "0" \
  }, \
  "timeoutMs": 180000 \
}'

# Default command runs tests
CMD ["pytest", "tests/e2e", "-v"]